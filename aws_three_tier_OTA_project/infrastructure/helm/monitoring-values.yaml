# Prometheus Stack Values
prometheus-stack:
  prometheus:
    enabled: true
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: gp3
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      resources:
        requests:
          memory: 2Gi
          cpu: 500m
        limits:
          memory: 4Gi
          cpu: 1
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false
      additionalScrapeConfigs:
        - job_name: 'kubernetes-pods'
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
              action: keep
              regex: true
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: kubernetes_namespace
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: kubernetes_pod_name

  grafana:
    enabled: true
    adminPassword: "${GRAFANA_ADMIN_PASSWORD}"
    persistence:
      enabled: true
      storageClassName: gp3
      size: 10Gi
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 200m
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default
          - name: 'ota-travel'
            orgId: 1
            folder: 'OTA Travel'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/ota-travel
    dashboards:
      default:
        kubernetes-cluster:
          gnetId: 6417
          revision: 1
          datasource: Prometheus
        kubernetes-pods:
          gnetId: 6336
          revision: 1
          datasource: Prometheus
        jvm-micrometer:
          gnetId: 4701
          revision: 9
          datasource: Prometheus
      ota-travel:
        booking-service:
          json: |
            {
              "title": "OTA Travel - Booking Service",
              "uid": "ota-booking",
              "panels": [
                {
                  "title": "Bookings Created",
                  "type": "stat",
                  "targets": [
                    {
                      "expr": "increase(bookings_created_total[24h])",
                      "legendFormat": "Bookings"
                    }
                  ]
                },
                {
                  "title": "Request Rate",
                  "type": "graph",
                  "targets": [
                    {
                      "expr": "rate(http_server_requests_seconds_count{application=\"booking-service\"}[5m])",
                      "legendFormat": "{{method}} {{uri}}"
                    }
                  ]
                },
                {
                  "title": "Response Time (p99)",
                  "type": "graph",
                  "targets": [
                    {
                      "expr": "histogram_quantile(0.99, rate(http_server_requests_seconds_bucket{application=\"booking-service\"}[5m]))",
                      "legendFormat": "{{uri}}"
                    }
                  ]
                }
              ]
            }
    grafana.ini:
      server:
        root_url: https://grafana.ota-travel.example.com
      auth:
        disable_login_form: false
      auth.anonymous:
        enabled: false

  alertmanager:
    enabled: true
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: gp3
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
    config:
      global:
        slack_api_url: '${SLACK_WEBHOOK_URL}'
      route:
        group_by: ['alertname', 'namespace', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        receiver: 'slack-notifications'
        routes:
          - match:
              severity: critical
            receiver: 'pagerduty-critical'
          - match:
              severity: warning
            receiver: 'slack-notifications'
      receivers:
        - name: 'slack-notifications'
          slack_configs:
            - channel: '#ota-travel-alerts'
              send_resolved: true
              title: '{{ .Status | toUpper }} - {{ .CommonAnnotations.summary }}'
              text: '{{ .CommonAnnotations.description }}'
        - name: 'pagerduty-critical'
          pagerduty_configs:
            - service_key: '${PAGERDUTY_SERVICE_KEY}'
              severity: critical

# Custom PrometheusRules for OTA Travel
additionalPrometheusRulesMap:
  ota-travel-rules:
    groups:
      - name: ota-travel.rules
        rules:
          - alert: HighErrorRate
            expr: |
              (
                sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (application)
                /
                sum(rate(http_server_requests_seconds_count[5m])) by (application)
              ) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: High error rate in {{ $labels.application }}
              description: Error rate is {{ $value | humanizePercentage }} for {{ $labels.application }}
          
          - alert: HighResponseTime
            expr: |
              histogram_quantile(0.99, rate(http_server_requests_seconds_bucket[5m])) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: High response time in {{ $labels.application }}
              description: P99 response time is {{ $value | humanizeDuration }} for {{ $labels.application }}
          
          - alert: PodHighMemoryUsage
            expr: |
              (container_memory_usage_bytes{namespace="production"}
              / container_spec_memory_limit_bytes{namespace="production"}) > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: High memory usage in {{ $labels.pod }}
              description: Memory usage is at {{ $value | humanizePercentage }}
          
          - alert: DatabaseConnectionPoolExhausted
            expr: |
              hikaricp_connections_active / hikaricp_connections_max > 0.9
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Database connection pool nearly exhausted
              description: Active connections at {{ $value | humanizePercentage }} of max
          
          - alert: HighBookingFailureRate
            expr: |
              (
                sum(rate(bookings_failed_total[5m]))
                /
                sum(rate(bookings_created_total[5m]))
              ) > 0.1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: High booking failure rate
              description: Booking failure rate is {{ $value | humanizePercentage }}
          
          - alert: PaymentProcessingDelayed
            expr: |
              histogram_quantile(0.95, rate(payment_processing_duration_seconds_bucket[5m])) > 30
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Payment processing is slow
              description: P95 payment processing time is {{ $value | humanizeDuration }}
