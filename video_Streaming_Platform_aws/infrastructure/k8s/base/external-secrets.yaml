apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: streamflix
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
  data:
    - secretKey: DB_HOST
      remoteRef:
        key: streamflix/production/database
        property: host
    - secretKey: DB_NAME
      remoteRef:
        key: streamflix/production/database
        property: name
    - secretKey: DB_USERNAME
      remoteRef:
        key: streamflix/production/database
        property: username
    - secretKey: DB_PASSWORD
      remoteRef:
        key: streamflix/production/database
        property: password

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: redis-credentials
    creationPolicy: Owner
  data:
    - secretKey: REDIS_HOST
      remoteRef:
        key: streamflix/production/redis
        property: host
    - secretKey: REDIS_AUTH_TOKEN
      remoteRef:
        key: streamflix/production/redis
        property: auth_token

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: streamflix
spec:
  refreshInterval: "24h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: jwt-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: streamflix/production/jwt
        property: secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: streamflix/production/jwt
        property: refresh_secret

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: aws-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: aws-credentials
    creationPolicy: Owner
  data:
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: streamflix/production/aws
        property: access_key_id
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: streamflix/production/aws
        property: secret_access_key
    - secretKey: S3_SOURCE_BUCKET
      remoteRef:
        key: streamflix/production/aws
        property: s3_source_bucket
    - secretKey: S3_TRANSCODED_BUCKET
      remoteRef:
        key: streamflix/production/aws
        property: s3_transcoded_bucket
    - secretKey: CLOUDFRONT_DOMAIN
      remoteRef:
        key: streamflix/production/aws
        property: cloudfront_domain
    - secretKey: CLOUDFRONT_KEY_PAIR_ID
      remoteRef:
        key: streamflix/production/aws
        property: cloudfront_key_pair_id
    - secretKey: CLOUDFRONT_PRIVATE_KEY
      remoteRef:
        key: streamflix/production/aws
        property: cloudfront_private_key

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ses-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: ses-credentials
    creationPolicy: Owner
  data:
    - secretKey: SES_FROM_EMAIL
      remoteRef:
        key: streamflix/production/ses
        property: from_email
    - secretKey: SES_REGION
      remoteRef:
        key: streamflix/production/ses
        property: region

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: stripe-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: stripe-credentials
    creationPolicy: Owner
  data:
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: streamflix/production/stripe
        property: secret_key
    - secretKey: STRIPE_PUBLISHABLE_KEY
      remoteRef:
        key: streamflix/production/stripe
        property: publishable_key
    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: streamflix/production/stripe
        property: webhook_secret

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: elasticsearch-credentials
  namespace: streamflix
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: elasticsearch-credentials
    creationPolicy: Owner
  data:
    - secretKey: ELASTICSEARCH_HOST
      remoteRef:
        key: streamflix/production/elasticsearch
        property: host
    - secretKey: ELASTICSEARCH_USERNAME
      remoteRef:
        key: streamflix/production/elasticsearch
        property: username
    - secretKey: ELASTICSEARCH_PASSWORD
      remoteRef:
        key: streamflix/production/elasticsearch
        property: password

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: streamflix
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/streamflix-external-secrets-role
